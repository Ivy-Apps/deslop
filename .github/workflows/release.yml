name: Release & Homebrew

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build & Release (Apple Silicon)
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Haskell
        uses: ./.github/actions/setup-haskell

      - name: Build Binary
        run: |
          cabal build all --enable-tests
          mkdir -p dist
          cp $(cabal list-bin deslop) dist/deslop
          strip dist/deslop

      - name: Compress Binary
        run: |
          cd dist
          tar -czf deslop-aarch64-apple-darwin.tar.gz deslop

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: dist/deslop-aarch64-apple-darwin.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Tap Repository
        uses: actions/checkout@v4
        with:
          repository: ivy-apps/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update Formula
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG#v}
          
          # Download only the ARM asset
          wget -q -O deslop-arm.tar.gz "https://github.com/ivy-apps/deslop/releases/download/$TAG/deslop-aarch64-apple-darwin.tar.gz"
          SHA_ARM=$(sha256sum deslop-arm.tar.gz | awk '{print $1}')

          # Generate Formula
          cat > tap/Formula/deslop.rb <<'EOF'
          class Deslop < Formula
            desc "A CLI tool for the Deslop project"
            homepage "https://github.com/ivy-apps/deslop"
            version "VERSION_PLACEHOLDER"
            license "BSD-3-Clause"

            # Only supporting Apple Silicon
            if OS.mac? && Hardware::CPU.arm?
              url "https://github.com/ivy-apps/deslop/releases/download/TAG_PLACEHOLDER/deslop-aarch64-apple-darwin.tar.gz"
              sha256 "SHA_ARM_PLACEHOLDER"
            end

            def install
              bin.install "deslop"
            end

            test do
              system "#{bin}/deslop", "--help"
            end
          end
          EOF

          sed -i "s|VERSION_PLACEHOLDER|$VERSION|g" tap/Formula/deslop.rb
          sed -i "s|TAG_PLACEHOLDER|$TAG|g" tap/Formula/deslop.rb
          sed -i "s|SHA_ARM_PLACEHOLDER|$SHA_ARM|g" tap/Formula/deslop.rb

          cd tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/deslop.rb
          git commit -m "Update deslop formula to $TAG" || echo "No changes to commit"
          git push